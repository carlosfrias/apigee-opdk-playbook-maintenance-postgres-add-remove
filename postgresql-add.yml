---
- hosts: planet
  tasks:
  - setup:
  - ec2_facts:

- hosts: '{{ hosts }}'
  vars:
    pgmaster_group_name: 'dc-2-pgmaster'
    pgstandby_group_name: 'dc-2-pgstandby'
  vars_files:
  - ~/.apigee/credentials.yml
  roles:
  - apigee-opdk-setup-default-settings
  - { role: apigee-opdk-server-self, server_type: 'ps'}
  - apigee-opdk-setup-postgresql-add

#  tasks:
#  - name: Construct uuid for master,standby
#    set_fact:
#      master_standby_uuid: "{{ hostvars[groups[pgmaster_group_name][0]].edge_ps_self.uUID }},{{ hostvars[groups[pgstandby_group_name][0]].edge_ps_self.uUID }}"
#
#  - name: Add postgres server
#    uri:
#      user: '{{ opdk_user_email }}'
#      password: '{{ opdk_user_pass }}'
#      method: POST
#      body_format: json
#      url: http://{{ local_mgmt_ip }}:8080/v1/analytics/groups/ax/{{ ax_group }}/servers?uuid={{ master_standby_uuid}}&type={{ hostvars[groups[pgmaster_group_name][0]].edge_ps_self.type[0] }}&force=true
#
#  - name: Add postgres to consumer groups
#    uri:
#      user: '{{ opdk_user_email }}'
#      password: '{{ opdk_user_pass }}'
#      method: POST
#      url: http://{{ local_mgmt_ip }}:8080/v1/analytics/groups/ax/{{ ax_group }}/consumer-groups/{{ consumer_group }}/datastores?uuid={{ master_standby_uuid }}
#      body_format: json
#
